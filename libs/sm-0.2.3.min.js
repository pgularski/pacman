/*! smjs 2016-05-27 */
"'use strict";var sm={};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=sm),exports.sm=sm):this.sm=sm,sm.id=0,sm.toType=function(obj){return{}.toString.call(obj).match(/\s([a-zA-Z]+)/)[1].toLowerCase()},sm.hasLength=function(obj){return obj?"number"==typeof obj.length:!1},sm.Queue=function(){var self=this;self.queue=[]},sm.Queue.prototype.put=function(value){var self=this;self.queue.push(value)},sm.Queue.prototype.get=function(){var self=this;return self.queue.shift()},sm.Queue.prototype.empty=function(){var self=this;return 0===self.queue.length},sm.StateMachineException=function(message){var self=this;self.name="StateMachineException",self.message=message},sm.Event=function(name,input,propagate,cargo){var self=this;self.name=name,self.input=input,self.propagate="undefined"!=typeof propagate?propagate:!0,self.cargo=cargo,self.stateMachine=null},sm.State=function(name){var self=this;self.parent=null,self.name=name,self.id=sm.id++,self.handlers={},self.initial=!1,self.registerHandlers()},sm.State.prototype.toString=function(){var self=this;return"<State "+self.name+" #"+self.id+">"},sm.State.prototype.isSubstate=function(state){var self=this;if(state===self)return!0;for(var parent=self.parent;null!==parent;){if(parent===state)return!0;parent=parent.parent}return!1},sm.State.prototype.registerHandlers=function(){},sm.State.prototype.on=function(event){var self=this;self.handlers.hasOwnProperty(event.name)&&(event.propagate=!1,self.handlers[event.name](self,event)),self.parent&&event.propagate&&("exit"!==event.name||"enter"!==event.name)&&self.parent.on(event)},sm.State.prototype._nop=function(state,event){return!0},sm.TransitionContainer=function(stateMachine){var self=this;self.stateMachine=stateMachine,self._transitions={}},sm.TransitionContainer.prototype.add=function(key,transition){var self=this;self._transitions.hasOwnProperty(key)||(self._transitions[key]=[]),self._transitions[key].push(transition)},sm.TransitionContainer.prototype.get=function(event){var self=this,key=[self.stateMachine.state,event.name,event.input];return self._getTransitionMatchingCondition(key,event)},sm.TransitionContainer.prototype._getTransitionMatchingCondition=function(key,event){var self=this;key=key.toString();for(var transitions=self._transitions[key]||[],fromState=self.stateMachine.leafState(),i=0;i<transitions.length;i++){var transition=transitions[i];if(transition.condition(fromState,event)===!0)return transitions[i]}},sm.Stack=function(maxlen){var self=this;self.stack=[],self.maxlen=maxlen},sm.Stack.prototype.pop=function(){var self=this;self.stack.pop()},sm.Stack.prototype.push=function(value){var self=this;self.stack.push(value),self.maxlen&&self.stack.length>self.maxlen&&self.stack.shift()},sm.Stack.prototype.peek=function(){var self=this;return self.stack[self.stack.length-1]},sm.StateMachine=function(name){var self=this;sm.State.call(self,name),self.states=[],self.state=null,self._transitions=new sm.TransitionContainer(self),self.stateStack=new sm.Stack(32),self.leafStateStack=new sm.Stack(32),self.stack=new sm.Stack},sm.StateMachine.prototype=new sm.State,sm.StateMachine.prototype.constructor=sm.StateMachine,sm.StateMachine.prototype.addState=function(state,initial){var self=this;new sm.Validator(self).validateAddState(state,initial),state.initial=initial,state.parent=self,self.states.push(state)},sm.StateMachine.prototype.addStates=function(states){for(var self=this,i=0;i<states.length;i++)self.states.push(states[i])},sm.StateMachine.prototype.setInitialState=function(state){var self=this;new sm.Validator(self).validateSetInitial(state),state.initial=!0},sm.StateMachine.prototype.initialState=function(){for(var self=this,initialState=null,i=0;i<self.states.length;i++){var state=self.states[i];if(state.initial)return state}return initialState},sm.StateMachine.prototype.rootMachine=function(){for(var self=this,machine=self;machine.parent;)machine=machine.parent;return machine},sm.StateMachine.prototype.addTransition=function(fromState,toState,events,input,action,condition,before,after){var self=this;input||(input=[null]),action||(action=self._nop),before||(before=self._nop),after||(after=self._nop),condition||(condition=self._nop),new sm.Validator(self).validateAddTransition(fromState,toState,events,input);for(var i=0;i<input.length;i++)for(var j=0;j<events.length;j++){var key=[fromState,events[j],input[i]],transition={fromState:fromState,toState:toState,action:action,condition:condition,before:before,after:after};self._transitions.add(key,transition)}},sm.StateMachine.prototype.getTransition=function(event){for(var self=this,machine=self.leafState().parent;machine;){var transition=machine._transitions.get(event);if(transition)return transition;machine=machine.parent}},sm.StateMachine.prototype.leafState=function(){var self=this;return self._getLeafState(self)},sm.StateMachine.prototype._getLeafState=function(state){for(;state.hasOwnProperty("state")&&state.state;)state=state.state;return state},sm.StateMachine.prototype.initialize=function(){function addStateToMachines(state){state instanceof sm.StateMachine&&machines.put(state)}var self=this,machines=new sm.Queue;for(machines.put(self);!machines.empty();){var machine=machines.get();new sm.Validator(self).validateInitialState(machine),machine.state=machine.initialState();var states=machine.states;states.forEach(addStateToMachines)}},sm.StateMachine.prototype.dispatch=function(event){var self=this;leafStateBefore=self.leafState(),leafStateBefore.on(event);var transition=self.getTransition(event);if(!transition)return null;var toState=transition.toState,fromState=transition.fromState;transition.before(leafStateBefore,event);var topState=self._exitStates(event,fromState,toState);transition.action(leafStateBefore,event),self._enterStates(event,topState,toState),transition.after(self.leafState(),event)},sm.StateMachine.prototype._exitStates=function(event,fromState,toState){if(toState){var self=this,state=self.leafState();for(self.leafStateStack.push(state);state.parent&&(!fromState.isSubstate(state)||!toState.isSubstate(state))||state===fromState&&state===toState;){var exitEvent=new sm.Event("exit",void 0,!1,{sourceEvent:event});exitEvent.stateMachine=self,state.on(exitEvent),state.parent.stateStack.push(state),state.parent.state=state.parent.initialState(),state=state.parent}return state}},sm.StateMachine.prototype._enterStates=function(event,topState,toState){if(toState){for(var self=this,path=[],state=self._getLeafState(toState);state.parent&&state!==topState;)path.push(state),state=state.parent;path.reverse();for(var i=0;i<path.length;i++){state=path[i];var enterEvent=new sm.Event("enter",void 0,!1,{sourceEvent:event});enterEvent.stateMachine=self,state.on(enterEvent),state.parent.state=state}}},sm.Validator=function(stateMachine){var self=this;self.stateMachine=stateMachine,self.template='Machine "'+stateMachine.name+'" error: '},sm.Validator.prototype._raise=function(msg){var self=this;throw new sm.StateMachineException(self.template+msg)},sm.Validator.prototype.validateAddState=function(state,initial){var self=this;if(!(state instanceof sm.State)){var msg="Unable to add state of type "+sm.toType(state);self._raise(msg)}self._validateStateAlreadyAdded(state),initial&&self.validateSetInitial(state)},sm.Validator.prototype._validateStateAlreadyAdded=function(state){function addStateToMachines(state){state instanceof sm.StateMachine&&machines.put(state)}var self=this,rootMachine=self.stateMachine.rootMachine(),machines=new sm.Queue;for(machines.put(rootMachine);!machines.empty();){var machine=machines.get(),states=machine.states;if(states.indexOf(state)>=0&&machine!==self.stateMachine){var msg='Machine "'+self.stateMachine.name+'" error: State "'+state.name+'" is already added to machine "'+machine.name+'"';self._raise(msg)}states.forEach(addStateToMachines)}},sm.Validator.prototype.validateSetInitial=function(state){var self=this,states=self.stateMachine.states;states.forEach(function(addedState){if(addedState.initial&&addedState!==state){var msg='Unable to set initial state to "'+state.name+'". Initial state is already set to "'+addedState.name+'"';self._raise(msg)}})},sm.Validator.prototype.validateAddTransition=function(fromState,toState,events,input){var self=this;self._validateFromState(fromState),self._validateToState(toState),self._validateEvents(events),self._validateInput(input)},sm.Validator.prototype._validateFromState=function(fromState){var self=this;if(self.stateMachine.states.indexOf(fromState)<0){var msg='Unable to add transition from unknown state "'+fromState.name+'"';self._raise(msg)}},sm.Validator.prototype._validateToState=function(toState){var self=this,rootMachine=self.stateMachine.rootMachine();if(toState&&toState!==rootMachine&&!toState.isSubstate(rootMachine)){var msg='Unable to add transition to unknown state "'+toState.name+'"';self._raise(msg)}},sm.Validator.prototype._validateEvents=function(events){var self=this;if(!sm.hasLength(events)){var msg="Unable to add transition, events is not iterable: "+events;self._raise(msg)}},sm.Validator.prototype._validateInput=function(input){var self=this;if(!sm.hasLength(input)){var msg="Unable to add transition, input is not iterable: "+input;self._raise(msg)}},sm.Validator.prototype.validateInitialState=function(machine){var self=this;if(machine.states.length>0&&!machine.initialState()){var msg='Machine "'+machine.name+'" has no initial state';self._raise(msg)}};